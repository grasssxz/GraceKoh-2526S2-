<script src="../checkCountry.js"></script>
<script src="../../header.js"></script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Furniture Details</title>
</head>

<body>
<script>
/* =======================
   INITIAL SETUP
======================= */
const countryPrefix = localStorage.getItem('urlPrefix');
const countryId = localStorage.getItem('countryId');
const memberEmail = sessionStorage.getItem('memberEmail');

const currentUrl = new URL(window.location.href);
const sku = currentUrl.searchParams.get("sku");
const storeIDParam = currentUrl.searchParams.get("storeID");

if (!sku) {
  window.location.href = `/B/${countryPrefix}/index.html`;
}

/* =======================
   LOAD PRODUCT DETAILS
======================= */
fetch(`/api/getFurnitureBySku?sku=${sku}&countryId=${countryId}`)
  .then(res => res.json())
  .then(furniture => {

    document.getElementById("imgFurniture").src = furniture.imageURL;
    document.getElementById("furnitureName").innerText = furniture.name;
    document.getElementById("description").innerText = furniture.description;
    document.getElementById("price").innerText = `$${furniture.price}`;

    document.getElementById("categoryLink").innerText = furniture.category;
    document.getElementById("categoryLink").href =
      `/B/${countryPrefix}/furnitureCategory.html?cat=${encodeURIComponent(furniture.category)}`;

    if (memberEmail) {
      document.getElementById("addToCartBtn").innerHTML = `
        <button class="btn btn-primary"
          onclick="addToCart(
            '${furniture.sku}',
            '${furniture.id}',
            ${furniture.price},
            '${furniture.name}',
            '${furniture.imageURL}'
          )">
          Add To Cart
        </button>
      `;
    }

    populateStoreDropdown(storeIDParam);
    if (storeIDParam) {
      checkItemAvailability(storeIDParam);
    }
  })
  .catch(console.error);

/* =======================
   STORE DROPDOWN
======================= */
function populateStoreDropdown(selectedId) {
  const stores = JSON.parse(localStorage.getItem('storesInCountry')) || [];
  let html = `<option value="">Select Store</option>`;

  stores.forEach(store => {
    html += `
      <option value="${store.id}" ${store.id == selectedId ? 'selected' : ''}>
        ${store.name}
      </option>
    `;
  });

  document.getElementById("storeID").innerHTML = html;
}

/* =======================
   CHECK AVAILABILITY
======================= */
function checkItemAvailability(storeId) {
  fetch(`/api/getItemQuantity?sku=${sku}&storeId=${storeId}`)
    .then(res => res.json())
    .then(data => {
      let quantity = data[0]?.sum ?? 0;

      document.getElementById("quantityDiv").innerHTML = `
        <div class="col-md-6">
          Status: <strong>${quantity > 0 ? 'Available' : 'Unavailable'}</strong><br/>
          Remaining Qty: ${quantity}
        </div>
      `;
    })
    .catch(console.error);
}

/* =======================
   ADD TO CART
======================= */
function addToCart(sku, id, price, name, imageURL) {

  fetch(`/api/getItemQuantity?sku=${sku}&storeId=-1`)
    .then(res => res.json())
    .then(data => {
      let availableQty = data[0]?.sum ?? 0;

      if (availableQty <= 0) {
        alert("Item not added. No stock available.");
        return;
      }

      let cart = JSON.parse(sessionStorage.getItem('shoppingCart')) || [];
      let item = cart.find(i => i.sku === sku);

      if (item) {
        if (item.quantity >= availableQty) {
          alert("Item not added. Not enough stock.");
          return;
        }
        item.quantity++;
      } else {
        cart.push({
          id, sku, price, name,
          imgURL: imageURL,
          quantity: 1
        });
      }

      sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
      alert("Item added to cart!");
    })
    .catch(console.error);
}

/* =======================
   EVENT HANDLER
======================= */
function onCheckAvailability() {
  const storeId = document.getElementById("storeID").value;
  if (storeId) {
    checkItemAvailability(storeId);
  }
}
</script>

<script src="menu2.js"></script>

<div class="body">
  <div role="main" class="main">

    <section class="page-top">
      <div class="container">
        <h2>Furniture</h2>
      </div>
    </section>

    <div class="container">
      <div class="row">

        <div class="col-md-6">
          <img id="imgFurniture" class="img-responsive img-rounded" />
        </div>

        <div class="col-md-6">
          <h2 id="furnitureName"></h2>
          <div id="addToCartBtn"></div>

          <h4 id="price"></h4>
          <strong>Description</strong>
          <p id="description"></p>

          <div class="product_meta">
            Category: <a id="categoryLink"></a>
          </div>

          <hr/>

          <form onsubmit="return false;">
            View Item Availability<br/>
            <select id="storeID" onchange="onCheckAvailability()"></select><br/><br/>
            <button class="btn btn-primary">Check Availability</button>
          </form>

          <div class="row" id="quantityDiv"></div>
        </div>

      </div>
    </div>

  </div>
</div>

<script src="../footer.js"></script>
</body>
</html>
